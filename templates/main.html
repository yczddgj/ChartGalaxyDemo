<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChartGalaxy - ä¿¡æ¯å›¾è¡¨ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: white;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            padding: 25px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input[type="number"] {
            -moz-appearance: textfield;
        }

        .form-input[type="color"] {
            padding: 4px;
            height: 46px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        #canvas-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e1e8ed;
            margin-top: 20px;
            overflow: auto;
        }

        #fabricCanvas {
            border: 1px dashed #ccc;
        }

        .color-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-input-wrapper input[type="color"] {
            flex: 0 0 60px;
        }

        .color-input-wrapper input[type="text"] {
            flex: 1;
            text-transform: uppercase;
        }

        .loading {
            font-size: 1.1rem;
            color: #666;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e1e8ed;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e74c3c;
            font-weight: 600;
            text-align: center;
            padding: 15px;
            background: #fdecea;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 15px;
            }

            .form-select, .form-input {
                padding: 10px 12px;
            }
        }

        /* Refined image preview section */
        #refined-preview-section {
            display: none;
            margin-top: 30px;
        }

        #refined-preview-section.show {
            display: block;
        }

        .refined-preview-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 25px;
        }

        .refined-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .refined-preview-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.3rem;
        }

        .refined-image-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e1e8ed;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .comparison-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e1e8ed;
        }

        .comparison-item h4 {
            margin: 0 0 15px 0;
            color: #555;
            font-size: 1.1rem;
            text-align: center;
        }

        .comparison-item img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        .refined-image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ChartGalaxy ä¿¡æ¯å›¾è¡¨ç”Ÿæˆå™¨</h1>
    </div>

    <div class="container">
        <div class="card">
            <div class="controls">
                <div class="control-group">
                    <label class="form-label">ç”»å¸ƒæ¯”ä¾‹</label>
                    <select class="form-select" id="aspectRatioSelector">
                        <option value="4:3" selected>4:3 (æ¨ªå‘)</option>
                        <option value="16:9">16:9 (å®½å±)</option>
                        <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                        <option value="3:4">3:4 (çºµå‘)</option>
                        <option value="9:16">9:16 (æ‰‹æœºç«–å±)</option>
                        <option value="2:1">2:1 (è¶…å®½)</option>
                        <option value="1:2">1:2 (è¶…é«˜)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="form-label">èƒŒæ™¯é¢œè‰²</label>
                    <div class="color-input-wrapper">
                        <input class="form-input" type="color" id="bgColorPicker" value="#f5f3ef">
                        <input class="form-input" type="text" id="bgColorText" value="#f5f3ef" maxlength="7" placeholder="#f5f3ef">
                    </div>
                </div>

                <div class="control-group">
                    <label class="form-label">é€æ˜åº¦: <span id="opacityValue">100</span>%</label>
                    <input class="form-input" type="range" id="opacitySlider" min="0" max="100" value="100" step="1">
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="exportAsSVG()">å¯¼å‡º SVG</button>
            <button class="btn btn-primary" onclick="exportAsPNG()">å¯¼å‡º PNG</button>
            <button class="btn btn-success" onclick="generateRefinedVersion()">ç”Ÿæˆç²¾ä¿®ç‰ˆ</button>
            <button class="btn btn-secondary" onclick="undo()" id="undoBtn">â†¶ æ’¤é”€</button>
            <button class="btn btn-secondary" onclick="redo()" id="redoBtn">â†· é‡åš</button>
            <button class="btn btn-secondary" onclick="bringToFront()">ç½®äºé¡¶å±‚</button>
            <button class="btn btn-secondary" onclick="sendToBack()">ç½®äºåº•å±‚</button>
            <button class="btn btn-danger" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</button>
        </div>

        <div id="canvas-container">
            <canvas id="fabricCanvas"></canvas>
        </div>
    </div>

    <!-- Refined image preview section (inline, below canvas) -->
    <div class="container" id="refined-preview-section">
        <div class="refined-preview-card">
            <div class="refined-preview-header">
                <h3>AI ç²¾ä¿®ç‰ˆ</h3>
                <button class="btn btn-success" onclick="downloadRefinedImage()">ä¸‹è½½ç²¾ä¿®ç‰ˆ</button>
            </div>
            <div class="comparison-grid">
                <div class="comparison-item">
                    <h4>âœ¨ ç²¾ä¿®ç»“æœ</h4>
                    <img id="refinedImagePreview" class="refined-image-preview" src="" alt="ç²¾ä¿®ç‰ˆå›¾ç‰‡">
                </div>
                <div class="comparison-item">
                    <h4>ğŸ“‹ å‚è€ƒå›¾è¡¨</h4>
                    <img id="referenceImagePreview" class="refined-image-preview" src="" alt="å‚è€ƒå›¾è¡¨">
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script>
// å…¨å±€å˜é‡
let canvas;
let currentBgColor = '#ffffff';

// æ’¤é”€/é‡åšå†å²è®°å½•
let undoStack = [];
let redoStack = [];
let isUndoRedoAction = false;

// ç”»å¸ƒæ¯”ä¾‹é…ç½®
const aspectRatios = {
    '4:3': { width: 800, height: 600 },
    '16:9': { width: 960, height: 540 },
    '1:1': { width: 700, height: 700 },
    '3:4': { width: 600, height: 800 },
    '9:16': { width: 450, height: 800 },
    '2:1': { width: 1000, height: 500 },
    '1:2': { width: 400, height: 800 }
};

// åˆå§‹åŒ– Fabric Canvas
function initCanvas(width, height) {
    canvas = new fabric.Canvas('fabricCanvas', {
        width: width,
        height: height,
        backgroundColor: currentBgColor,
        selection: true,
        preserveObjectStacking: true
    });

    // è®¾ç½®é€‰ä¸­æ ·å¼
    fabric.Object.prototype.set({
        transparentCorners: false,
        cornerColor: '#667eea',
        cornerStrokeColor: '#667eea',
        borderColor: '#667eea',
        cornerSize: 10,
        padding: 5,
        cornerStyle: 'circle',
        borderScaleFactor: 2
    });

    // é”®ç›˜äº‹ä»¶ - åˆ é™¤é€‰ä¸­å¯¹è±¡
    document.addEventListener('keydown', function(e) {
        if ((e.key === 'Delete' || e.key === 'Backspace') && canvas.getActiveObject()) {
            deleteSelected();
        }
        // Ctrl+Z æ’¤é”€
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            undo();
        }
        // Ctrl+Y æˆ– Ctrl+Shift+Z é‡åš
        if (e.ctrlKey && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) {
            e.preventDefault();
            redo();
        }
    });

    // ç›‘å¬ç”»å¸ƒå˜åŒ–ï¼Œä¿å­˜å†å²è®°å½•
    canvas.on('object:added', saveState);
    canvas.on('object:modified', saveState);
    canvas.on('object:removed', saveState);

    // å½“é€‰ä¸­å¯¹è±¡æ—¶ï¼Œæ›´æ–°é€æ˜åº¦æ»‘å—çš„å€¼
    canvas.on('selection:created', function(e) {
        updateOpacitySlider(e.selected[0]);
    });

    canvas.on('selection:updated', function(e) {
        updateOpacitySlider(e.selected[0]);
    });

    canvas.on('selection:cleared', function() {
        // æ¸…é™¤é€‰æ‹©æ—¶ï¼Œé‡ç½®é€æ˜åº¦æ»‘å—ä¸º100%
        document.getElementById('opacitySlider').value = 100;
        document.getElementById('opacityValue').textContent = '100';
    });
}

// æ›´æ–°ç”»å¸ƒæ¯”ä¾‹
function updateCanvasAspectRatio(ratio) {
    const config = aspectRatios[ratio] || aspectRatios['4:3'];

    canvas.setWidth(config.width);
    canvas.setHeight(config.height);
    canvas.renderAll();
}

// æ›´æ–°èƒŒæ™¯é¢œè‰²
function updateBgColor(color) {
    if (!/^#[0-9A-Fa-f]{6}$/.test(color)) {
        return;
    }

    currentBgColor = color;
    canvas.setBackgroundColor(color, canvas.renderAll.bind(canvas));

    // åŒæ­¥ä¸¤ä¸ªè¾“å…¥æ§ä»¶
    document.getElementById('bgColorPicker').value = color;
    document.getElementById('bgColorText').value = color;
}

// æ·»åŠ å›¾ç‰‡åˆ°ç”»å¸ƒ
function addImageToCanvas(imageUrl, options = {}) {
    return new Promise((resolve, reject) => {
        fabric.Image.fromURL(imageUrl, function(img) {
            if (!img) {
                reject(new Error('Failed to load image'));
                return;
            }

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å›¾ç‰‡é€‚åº”ç”»å¸ƒ
            const maxWidth = options.maxWidth || 300;
            const maxHeight = options.maxHeight || 300;
            const scale = Math.min(
                maxWidth / img.width,
                maxHeight / img.height,
                1
            );

            img.set({
                left: options.left || Math.random() * (canvas.width - img.width * scale),
                top: options.top || Math.random() * (canvas.height - img.height * scale),
                scaleX: scale,
                scaleY: scale,
                lockUniScaling: true  // é”å®šç­‰æ¯”ç¼©æ”¾
            });

            canvas.add(img);
            canvas.renderAll();
            resolve(img);
        }, { crossOrigin: 'anonymous' });
    });
}

// æ·»åŠ  SVG åˆ°ç”»å¸ƒï¼ˆä½¿ç”¨å›¾ç‰‡æ–¹å¼åŠ è½½ä»¥ä¿è¯å…¼å®¹æ€§ï¼‰
function addSVGToCanvas(svgString, options = {}) {
    return new Promise((resolve, reject) => {
        // æ–¹æ³•1: å°è¯•å°† SVG è½¬æ¢ä¸º data URL ä½œä¸ºå›¾ç‰‡åŠ è½½
        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const svgUrl = URL.createObjectURL(svgBlob);

        fabric.Image.fromURL(svgUrl, function(img) {
            URL.revokeObjectURL(svgUrl);

            if (!img || !img.width || !img.height) {
                console.warn('Image load failed, trying SVG parse method...');
                // å›é€€åˆ° SVG è§£ææ–¹å¼
                addSVGToCanvasFallback(svgString, options).then(resolve).catch(reject);
                return;
            }

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const maxWidth = options.maxWidth || canvas.width * 0.8;
            const maxHeight = options.maxHeight || canvas.height * 0.8;
            const scale = Math.min(
                maxWidth / img.width,
                maxHeight / img.height,
                1
            );

            img.set({
                left: options.left || (canvas.width - img.width * scale) / 2,
                top: options.top || (canvas.height - img.height * scale) / 2,
                scaleX: scale,
                scaleY: scale,
                lockUniScaling: true
            });

            canvas.add(img);
            canvas.renderAll();
            resolve(img);
        }, { crossOrigin: 'anonymous' });
    });
}

// SVG è§£ææ–¹å¼ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
function addSVGToCanvasFallback(svgString, options = {}) {
    return new Promise((resolve, reject) => {
        fabric.loadSVGFromString(svgString, function(objects, svgOptions) {
            if (!objects || objects.length === 0) {
                reject(new Error('Failed to load SVG'));
                return;
            }

            const svgGroup = fabric.util.groupSVGElements(objects, svgOptions);

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const maxWidth = options.maxWidth || canvas.width * 0.8;
            const maxHeight = options.maxHeight || canvas.height * 0.8;
            const scale = Math.min(
                maxWidth / svgGroup.width,
                maxHeight / svgGroup.height,
                1
            );

            svgGroup.set({
                left: options.left || (canvas.width - svgGroup.width * scale) / 2,
                top: options.top || (canvas.height - svgGroup.height * scale) / 2,
                scaleX: scale,
                scaleY: scale,
                lockUniScaling: true
            });

            canvas.add(svgGroup);
            canvas.renderAll();
            resolve(svgGroup);
        });
    });
}

// ä¿å­˜ç”»å¸ƒçŠ¶æ€åˆ°å†å²è®°å½•
function saveState() {
    if (isUndoRedoAction) {
        // å¦‚æœæ˜¯æ’¤é”€/é‡åšæ“ä½œè§¦å‘çš„å˜åŒ–ï¼Œä¸ä¿å­˜çŠ¶æ€
        return;
    }

    // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€
    const state = JSON.stringify(canvas.toJSON());
    undoStack.push(state);

    // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤š50æ¡ï¼‰
    if (undoStack.length > 50) {
        undoStack.shift();
    }

    // æ¸…ç©ºé‡åšæ ˆ
    redoStack = [];

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateUndoRedoButtons();
}

// æ’¤é”€
function undo() {
    if (undoStack.length === 0) {
        return;
    }

    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšæ ˆ
    const currentState = JSON.stringify(canvas.toJSON());
    redoStack.push(currentState);

    // ä»æ’¤é”€æ ˆä¸­å–å‡ºä¸Šä¸€ä¸ªçŠ¶æ€
    const previousState = undoStack.pop();

    // æ ‡è®°ä¸ºæ’¤é”€æ“ä½œï¼Œé¿å…è§¦å‘saveState
    isUndoRedoAction = true;

    // æ¢å¤ç”»å¸ƒçŠ¶æ€
    canvas.loadFromJSON(previousState, function() {
        canvas.renderAll();
        isUndoRedoAction = false;
        updateUndoRedoButtons();
    });
}

// é‡åš
function redo() {
    if (redoStack.length === 0) {
        return;
    }

    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
    const currentState = JSON.stringify(canvas.toJSON());
    undoStack.push(currentState);

    // ä»é‡åšæ ˆä¸­å–å‡ºçŠ¶æ€
    const nextState = redoStack.pop();

    // æ ‡è®°ä¸ºé‡åšæ“ä½œï¼Œé¿å…è§¦å‘saveState
    isUndoRedoAction = true;

    // æ¢å¤ç”»å¸ƒçŠ¶æ€
    canvas.loadFromJSON(nextState, function() {
        canvas.renderAll();
        isUndoRedoAction = false;
        updateUndoRedoButtons();
    });
}

// æ›´æ–°æ’¤é”€/é‡åšæŒ‰é’®çŠ¶æ€
function updateUndoRedoButtons() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    if (undoBtn) {
        undoBtn.disabled = undoStack.length === 0;
    }
    if (redoBtn) {
        redoBtn.disabled = redoStack.length === 0;
    }
}

// åˆ é™¤é€‰ä¸­å¯¹è±¡
function deleteSelected() {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects.length > 0) {
        activeObjects.forEach(obj => canvas.remove(obj));
        canvas.discardActiveObject();
        canvas.renderAll();
    }
}

// ç½®äºé¡¶å±‚
function bringToFront() {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        canvas.bringToFront(activeObject);
        canvas.renderAll();
    }
}

// ç½®äºåº•å±‚
function sendToBack() {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        canvas.sendToBack(activeObject);
        canvas.renderAll();
    }
}

// å¯¼å‡ºä¸º SVG
function exportAsSVG() {
    const svgData = canvas.toSVG();
    const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'infographic.svg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// å¯¼å‡ºä¸º PNG
function exportAsPNG() {
    const dataURL = canvas.toDataURL({
        format: 'png',
        quality: 1,
        multiplier: 2  // 2x åˆ†è¾¨ç‡
    });
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = 'infographic.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ç”Ÿæˆç²¾ä¿®ç‰ˆ (ä½¿ç”¨ Gemini AI)
async function generateRefinedVersion() {
    try {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-overlay';
        loadingDiv.innerHTML = `
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <span id="refinement-status">æ­£åœ¨ä½¿ç”¨ AI ç²¾ä¿®ä¿¡æ¯å›¾è¡¨...</span>
            </div>
        `;
        loadingDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        document.body.appendChild(loadingDiv);

        // ä½¿ç”¨ç°æœ‰çš„å¯¼å‡º PNG åŠŸèƒ½è·å– PNG base64 æ•°æ®
        const pngDataURL = canvas.toDataURL({
            format: 'png',
            quality: 1,
            multiplier: 2  // 2x åˆ†è¾¨ç‡
        });

        // å‘é€åˆ°åç«¯è¿›è¡Œå¤„ç†
        const response = await fetch('/api/export_final', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                png_base64: pngDataURL
            })
        });

        const result = await response.json();

        if (result.status === 'started') {
            // è½®è¯¢æ£€æŸ¥çŠ¶æ€
            await pollRefinementStatus(loadingDiv);
        } else {
            throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
        }

    } catch (error) {
        console.error('ç”Ÿæˆç²¾ä¿®ç‰ˆå¤±è´¥:', error);
        alert('ç”Ÿæˆç²¾ä¿®ç‰ˆå¤±è´¥: ' + error.message);

        // ç§»é™¤åŠ è½½æç¤º
        const loadingDiv = document.querySelector('.loading-overlay');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
    }
}

// è½®è¯¢ç²¾ä¿®çŠ¶æ€
async function pollRefinementStatus(loadingDiv) {
    const maxAttempts = 120; // æœ€å¤šç­‰å¾…2åˆ†é’Ÿ
    let attempts = 0;

    const statusText = document.getElementById('refinement-status');

    while (attempts < maxAttempts) {
        try {
            const response = await fetch('/api/status');
            const status = await response.json();

            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            if (status.progress && statusText) {
                statusText.textContent = "";
            }

            if (status.step === 'final_export' && status.completed) {
                if (status.status === 'completed') {
                    // ç§»é™¤åŠ è½½æç¤º
                    document.body.removeChild(loadingDiv);

                    // æ˜¾ç¤ºç²¾ä¿®åçš„å›¾ç‰‡é¢„è§ˆï¼ˆå†…è”æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼‰
                    showRefinedImagePreview();

                    // æ»šåŠ¨åˆ°ç²¾ä¿®ç‰ˆé¢„è§ˆåŒºåŸŸ
                    document.getElementById('refined-preview-section').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });

                    return;
                } else if (status.status === 'error') {
                    throw new Error(status.progress || 'ç²¾ä¿®å¤±è´¥');
                }
            }

        } catch (error) {
            console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
        }

        await new Promise(resolve => setTimeout(resolve, 1000));
        attempts++;
    }

    // è¶…æ—¶
    document.body.removeChild(loadingDiv);
    throw new Error('ç²¾ä¿®è¶…æ—¶ï¼Œè¯·é‡è¯•');
}

// æ˜¾ç¤ºç²¾ä¿®åçš„å›¾ç‰‡é¢„è§ˆï¼ˆå†…è”æ˜¾ç¤ºï¼‰
async function showRefinedImagePreview() {
    const previewSection = document.getElementById('refined-preview-section');
    const imgPreview = document.getElementById('refinedImagePreview');
    const refPreview = document.getElementById('referenceImagePreview');

    // è®¾ç½®å›¾ç‰‡æºä¸ºåç«¯æä¾›çš„ç²¾ä¿®å›¾ç‰‡
    imgPreview.src = '/api/download_final?' + new Date().getTime(); // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜

    // è·å–å¹¶æ˜¾ç¤ºå‚è€ƒå›¾
    try {
        const response = await fetch('/api/status');
        const status = await response.json();
        const referenceImage = status.selected_reference;

        if (referenceImage) {
            // ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–å®Œæ•´URL
            refPreview.src = '/' + referenceImage + '?' + new Date().getTime();
        } else {
            // å¦‚æœæ²¡æœ‰å‚è€ƒå›¾ï¼Œéšè—å‚è€ƒå›¾å®¹å™¨
            refPreview.parentElement.style.display = 'none';
        }
    } catch (error) {
        console.error('è·å–å‚è€ƒå›¾å¤±è´¥:', error);
        refPreview.parentElement.style.display = 'none';
    }

    // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
    previewSection.classList.add('show');
}

// ä¸‹è½½ç²¾ä¿®åçš„å›¾ç‰‡
function downloadRefinedImage() {
    const link = document.createElement('a');
    link.href = '/api/download_final';
    link.download = 'infographic_refined.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// åŠ è½½å›¾è¡¨æ•°æ®
async function loadChartData(chartType, data, title, pictogram) {
    if (!chartType || !data) {
        alert("è¯·ç¡®ä¿å·²é€‰æ‹©æ•°æ®æºå’Œå›¾è¡¨ç±»å‹");
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const container = document.getElementById('canvas-container');
    const canvasEl = document.getElementById('fabricCanvas');
    canvasEl.style.display = 'none';

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading';
    loadingDiv.innerHTML = '<div class="loading-spinner"></div><span>æ­£åœ¨åŠ è½½å›¾è¡¨...</span>';
    container.appendChild(loadingDiv);

    try {
        const svgURL = `/authoring/chart?charttype=${encodeURIComponent(chartType)}&data=${encodeURIComponent(data)}&title=${encodeURIComponent(title)}&pictogram=${encodeURIComponent(pictogram)}`;

        const response = await fetch(svgURL);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        const { chart, img1, img2, bg_color, layout } = result;

        // æ¸…ç©ºç”»å¸ƒ
        canvas.clear();

        // è®¾ç½®èƒŒæ™¯è‰²
        if (bg_color) {
            updateBgColor(bg_color);
        } else {
            canvas.setBackgroundColor(currentBgColor, canvas.renderAll.bind(canvas));
        }

        // å¦‚æœæœ‰å¸ƒå±€ä¿¡æ¯ï¼Œä½¿ç”¨å¸ƒå±€ä¿¡æ¯æ¥è®¾ç½®ä½ç½®å’Œå¤§å°
        let chartOptions, titleOptions, imageOptions;

        if (layout && layout.chart && layout.title && layout.image) {
            console.log('ä½¿ç”¨å‚è€ƒå›¾å¸ƒå±€ä¿¡æ¯:', layout);

            // æ ¹æ®canvasçš„å®½é«˜å’Œå‚è€ƒå›¾çš„æ¯”ä¾‹è®¡ç®—å®é™…ä½ç½®å’Œå¤§å°
            chartOptions = {
                left: layout.chart.x * canvas.width,
                top: layout.chart.y * canvas.height,
                maxWidth: layout.chart.width * canvas.width,
                maxHeight: layout.chart.height * canvas.height
            };

            titleOptions = {
                left: layout.title.x * canvas.width,
                top: layout.title.y * canvas.height,
                maxWidth: layout.title.width * canvas.width,
                maxHeight: layout.title.height * canvas.height
            };

            imageOptions = {
                left: layout.image.x * canvas.width,
                top: layout.image.y * canvas.height,
                maxWidth: layout.image.width * canvas.width,
                maxHeight: layout.image.height * canvas.height
            };
        } else {
            // ä½¿ç”¨é»˜è®¤å¸ƒå±€
            console.log('ä½¿ç”¨é»˜è®¤å¸ƒå±€');
            chartOptions = {
                maxWidth: canvas.width * 0.9,
                maxHeight: canvas.height * 0.7,
                left: canvas.width * 0.05,
                top: canvas.height * 0.15
            };

            titleOptions = {
                maxWidth: 400,
                maxHeight: 150,
                left: 20,
                top: 20
            };

            imageOptions = {
                maxWidth: 200,
                maxHeight: 200,
                left: canvas.width - 220,
                top: canvas.height - 220
            };
        }

        // æ·»åŠ å›¾è¡¨å›¾ç‰‡ï¼ˆç°åœ¨æ˜¯ PNG è€Œä¸æ˜¯ SVGï¼‰
        if (chart) {
            await addImageToCanvas(chart, chartOptions);
        }

        // æ·»åŠ å›¾ç‰‡1 (æ ‡é¢˜)
        if (img1) {
            await addImageToCanvas(img1, titleOptions);
        }

        // æ·»åŠ å›¾ç‰‡2 (é…å›¾)
        if (img2) {
            await addImageToCanvas(img2, imageOptions);
        }

        // ä¿å­˜åˆå§‹çŠ¶æ€åˆ°æ’¤é”€æ ˆ
        setTimeout(() => {
            saveState();
        }, 100);

    } catch (err) {
        console.error("åŠ è½½å›¾è¡¨å¤±è´¥:", err);

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `åŠ è½½å›¾è¡¨å¤±è´¥: ${err.message}`;
        container.appendChild(errorDiv);
    } finally {
        // ç§»é™¤åŠ è½½çŠ¶æ€
        if (loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
        canvasEl.style.display = 'block';
    }
}

// äº‹ä»¶ç›‘å¬å™¨
document.getElementById('aspectRatioSelector').addEventListener('change', function() {
    updateCanvasAspectRatio(this.value);
});

document.getElementById('bgColorPicker').addEventListener('input', function() {
    updateBgColor(this.value);
});

document.getElementById('bgColorText').addEventListener('input', function() {
    let value = this.value;
    if (!value.startsWith('#')) {
        value = '#' + value;
    }
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
        updateBgColor(value);
    }
});

document.getElementById('bgColorText').addEventListener('blur', function() {
    this.value = currentBgColor;
});

// é€æ˜åº¦æ§åˆ¶
document.getElementById('opacitySlider').addEventListener('input', function() {
    const opacityPercent = this.value;
    const opacityValue = opacityPercent / 100;

    // æ›´æ–°æ˜¾ç¤ºçš„é€æ˜åº¦å€¼
    document.getElementById('opacityValue').textContent = opacityPercent;

    // è·å–å½“å‰é€‰ä¸­çš„å¯¹è±¡
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        // è®¾ç½®é€‰ä¸­å¯¹è±¡çš„é€æ˜åº¦
        activeObject.set('opacity', opacityValue);
        canvas.renderAll();
    }
});

// æ›´æ–°é€æ˜åº¦æ»‘å—çš„è¾…åŠ©å‡½æ•°
function updateOpacitySlider(obj) {
    if (obj) {
        const opacityPercent = Math.round((obj.opacity || 1) * 100);
        document.getElementById('opacitySlider').value = opacityPercent;
        document.getElementById('opacityValue').textContent = opacityPercent;
    }
}

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
    const initialChartType = "{{ charttype | safe }}";
    const initialData = "{{ data | safe }}";
    const initialTitle = "{{ title | safe }}";
    const initialPictogram = "{{ pictogram | safe }}";

    // åˆå§‹åŒ–ç”»å¸ƒ
    const config = aspectRatios['4:3'];
    initCanvas(config.width, config.height);

    // åˆå§‹åŒ–æ’¤é”€/é‡åšæŒ‰é’®çŠ¶æ€
    updateUndoRedoButtons();

    // åŠ è½½æ•°æ®
    if (initialChartType && initialData) {
        loadChartData(initialChartType, initialData, initialTitle, initialPictogram);
    }
});
    </script>
</body>
</html>
